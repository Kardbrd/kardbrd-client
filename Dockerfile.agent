FROM python:3.12-slim

RUN apt-get update && apt-get install -y git openssh-client curl && rm -rf /var/lib/apt/lists/*

RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
    && apt-get install -y nodejs && rm -rf /var/lib/apt/lists/*

RUN npm install -g @anthropic-ai/claude-code

COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

RUN useradd -m -s /bin/bash -u 1000 agent \
    && mkdir -p /home/agent/.ssh /home/agent/.claude /home/agent/repository /home/agent/workspaces /app/state \
    && chown -R agent:agent /home/agent /app/state

USER agent

WORKDIR /home/agent/repository

ENTRYPOINT ["uvx", "--from", "git+https://github.com/kardbrd/kardbrd-agent.git", "kardbrd-agent"]
CMD ["start", "--cwd", "/home/agent/repository"]
