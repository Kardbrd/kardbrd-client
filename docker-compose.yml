services:
  agent:
    build:
      context: .
      dockerfile: Dockerfile.agent
    restart: unless-stopped
    environment:
      - ANTHROPIC_API_KEY
      - LOG_LEVEL=INFO
      - AGENT_CWD=/home/agent/repository
      - AGENT_WORKTREES_DIR=/home/agent/workspaces
      - AGENT_SETUP_CMD=uv sync
      - AGENT_TEST_CMD=uv run pytest kardbrd_client/tests/
      - AGENT_MAX_CONCURRENT=2
      - AGENT_TIMEOUT=7200
      # - AGENT_MERGE_QUEUE_LIST=merge queue
      - GIT_AUTHOR_NAME=Kardbrd Agent
      - GIT_AUTHOR_EMAIL=agent@example.com
      - GIT_COMMITTER_NAME=Kardbrd Agent
      - GIT_COMMITTER_EMAIL=agent@example.com
    volumes:
      # Subscription state (persisted across restarts)
      - ./state:/app/state

      # Base repository (read-write)
      - ./repository:/home/agent/repository

      # Worktrees (separate from repo)
      - ./workspaces:/home/agent/workspaces

      # Claude CLI home (API creds, session data, settings)
      - ./claude:/home/agent/.claude

      # SSH key (read-only) â€” use a DEDICATED key, not personal
      - ./ssh/id_ed25519:/home/agent/.ssh/id_ed25519:ro
